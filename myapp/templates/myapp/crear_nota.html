{% extends 'myapp/base.html' %}
{% load static %}
{% load form_tags %}

{% block content %}
<div class="container mt-4">
    <h2>Crear Nota</h2>

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- Formulario de Nota -->
        <div class="card mb-3">
            <div class="card-body">
                {{ form.non_field_errors }}
                <div class="mb-3">
                    <label for="{{ form.titulo.id_for_label }}" class="form-label">T칤tulo</label>
                    {{ form.titulo|add_class:"form-control" }}
                    {% for error in form.titulo.errors %}
                        <div class="text-danger small">{{ error }}</div>
                    {% endfor %}
                </div>
                <div class="mb-3">
                    <label for="{{ form.descripcion.id_for_label }}" class="form-label">Descripci칩n</label>
                    {{ form.descripcion|add_class:"form-control" }}
                    {% for error in form.descripcion.errors %}
                        <div class="text-danger small">{{ error }}</div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Formset de Pasos -->
        <h4>Pasos</h4>
        <div id="formset-container">
            {{ formset.management_form }}
            {% for form in formset %}
                <div class="card mb-2 formset-form">
                    <div class="card-body">
                        {{ form.non_field_errors }}

                        <!-- 游녢 Incluimos el id aunque estar치 vac칤o en crear -->
                        {{ form.id }}

                        <div class="mb-2">
                            <label for="{{ form.titulo.id_for_label }}" class="form-label">T칤tulo</label>
                            {{ form.titulo|add_class:"form-control" }}
                            {% for error in form.titulo.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                        <div class="mb-2">
                            <label for="{{ form.descripcion.id_for_label }}" class="form-label">Descripci칩n</label>
                            {{ form.descripcion|add_class:"form-control" }}
                            {% for error in form.descripcion.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                        <div class="mb-2">
                            <label for="{{ form.codigo.id_for_label }}" class="form-label">C칩digo</label>
                            {{ form.codigo|add_class:"form-control" }}
                            {% for error in form.codigo.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                        <div class="mb-2">
                            <label for="{{ form.imagen.id_for_label }}" class="form-label">Imagen</label>
                            {{ form.imagen|add_class:"form-control" }}
                            {% for error in form.imagen.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>

        <!-- Bot칩n para a침adir m치s pasos -->
        <button type="button" class="btn btn-secondary mb-3" id="add-form">Agregar Paso</button>

        <!-- Botones finales -->
        <div class="mt-3">
            <button type="submit" class="btn btn-primary">Guardar Nota</button>
            <a href="{% url 'inicio' %}" class="btn btn-outline-secondary">Cancelar</a>
        </div>
    </form>
</div>

<!-- Template oculto para nuevos pasos -->
<template id="empty-form-template">
    <div class="card mb-2 formset-form">
        <div class="card-body">
            <!-- 游녢 Campo id incluido para consistencia -->
            {{ formset.empty_form.id }}
            <div class="mb-2">
                <label class="form-label">T칤tulo</label>
                {{ formset.empty_form.titulo|add_class:"form-control" }}
            </div>
            <div class="mb-2">
                <label class="form-label">Descripci칩n</label>
                {{ formset.empty_form.descripcion|add_class:"form-control" }}
            </div>
            <div class="mb-2">
                <label class="form-label">C칩digo</label>
                {{ formset.empty_form.codigo|add_class:"form-control" }}
            </div>
            <div class="mb-2">
                <label class="form-label">Imagen</label>
                {{ formset.empty_form.imagen|add_class:"form-control" }}
            </div>
        </div>
    </div>
</template>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const formsetContainer = document.getElementById("formset-container");
    const addFormBtn = document.getElementById("add-form");
    const emptyFormTemplate = document.getElementById("empty-form-template").innerHTML;

    // Detectar autom치ticamente el TOTAL_FORMS sin importar el prefijo
    const totalFormsInput = document.querySelector("input[name$='-TOTAL_FORMS']");

    addFormBtn.addEventListener("click", () => {
        let formCount = parseInt(totalFormsInput.value, 10);

        // Clonar el template y reemplazar __prefix__ por el 칤ndice real
        let newFormHtml = emptyFormTemplate.replace(/__prefix__/g, formCount);
        formsetContainer.insertAdjacentHTML("beforeend", newFormHtml);

        // Actualizar el n칰mero total de forms
        totalFormsInput.value = formCount + 1;
    });
});
</script>
{% endblock %}
