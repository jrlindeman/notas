{% extends 'myapp/base.html' %}
{% load static %}
{% load form_tags %}

{% block content %}
<div class="container-fluid">
    <h1 class="h3 mb-4 text-gray-800">Crear Nota</h1>

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        {{ form.media }} 

        <!-- Formulario de Nota -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 bg-primary text-white">
                <h6 class="m-0 font-weight-bold">Datos de la Nota</h6>
            </div>
            <div class="card-body">
                {{ form.non_field_errors }}

                <!-- Título -->
                <div class="mb-3">
                    <label for="{{ form.titulo.id_for_label }}" class="form-label">Título</label>
                    {{ form.titulo|add_class:"form-control" }}
                    {% for error in form.titulo.errors %}
                        <div class="text-danger small">{{ error }}</div>
                    {% endfor %}
                </div>

                <!-- Descripción -->
                <div class="mb-3">
                    <label for="{{ form.descripcion.id_for_label }}" class="form-label">Descripción</label>
                    {{ form.descripcion|add_class:"form-control" }}
                    {% for error in form.descripcion.errors %}
                        <div class="text-danger small">{{ error }}</div>
                    {% endfor %}
                </div>

                <!-- Categoría -->
                <div class="mb-3">
                    <label for="{{ form.categoria.id_for_label }}" class="form-label">Categoría</label>
                    {{ form.categoria|add_class:"form-control" }}
                    {% for error in form.categoria.errors %}
                        <div class="text-danger small">{{ error }}</div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Formset de Pasos -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 bg-primary text-white">
                <h6 class="m-0 font-weight-bold">Pasos</h6>
            </div>
            <div class="card-body">
                <div id="formset-container">
                    {{ formset.management_form }}

                    {% for form in formset %}
                        <div class="card mb-3 border-left-info formset-form">
                            <div class="card-body">
                                {{ form.non_field_errors }}
                                {{ form.id }}

                                <!-- Título Paso -->
                                <div class="mb-2">
                                    <label for="{{ form.titulo.id_for_label }}" class="form-label">Título</label>
                                    {{ form.titulo|add_class:"form-control" }}
                                    {% for error in form.titulo.errors %}
                                        <div class="text-danger small">{{ error }}</div>
                                    {% endfor %}
                                </div>

                                <!-- Descripción Paso -->
                                <div class="mb-2">
                                    <label for="{{ form.descripcion.id_for_label }}" class="form-label">Descripción</label>
                                    {{ form.descripcion|add_class:"form-control" }}
                                    {% for error in form.descripcion.errors %}
                                        <div class="text-danger small">{{ error }}</div>
                                    {% endfor %}
                                </div>

                                <!-- Código Paso -->
                                <div class="mb-2">
                                    <label for="{{ form.codigo.id_for_label }}" class="form-label">Código</label>
                                    {{ form.codigo|add_class:"form-control" }}
                                    {% for error in form.codigo.errors %}
                                        <div class="text-danger small">{{ error }}</div>
                                    {% endfor %}
                                </div>

                                <!-- Imagen Paso -->
                                <div class="mb-2">
                                    <label for="{{ form.imagen.id_for_label }}" class="form-label">Imagen</label>
                                    {{ form.imagen|add_class:"form-control" }}
                                    {% for error in form.imagen.errors %}
                                        <div class="text-danger small">{{ error }}</div>
                                    {% endfor %}
                                </div>

                                <!-- Opción Eliminar Paso -->
                                {% if form.DELETE %}
                                    <div class="form-check mt-2">
                                        {{ form.DELETE }}
                                        <label class="form-check-label" for="{{ form.DELETE.id_for_label }}">
                                            Eliminar este paso
                                        </label>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <!-- Botón Agregar Paso -->
                <button type="button" class="btn btn-info" id="add-form">
                    <i class="fas fa-plus"></i> Agregar Paso
                </button>
            </div>
        </div>

        <!-- Botones finales -->
        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-success">
                <i class="fas fa-save"></i> Guardar Nota
            </button>
            <a href="{% url 'inicio' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Cancelar
            </a>
        </div>
    </form>
</div>

<!-- Template oculto para nuevos pasos -->
<template id="empty-form-template">
    <div class="card mb-3 border-left-info formset-form">
        <div class="card-body">
            {{ formset.empty_form.id }}

            <div class="mb-2">
                <label class="form-label">Título</label>
                {{ formset.empty_form.titulo|add_class:"form-control" }}
            </div>

            <div class="mb-2">
                <label class="form-label">Descripción</label>
                {{ formset.empty_form.descripcion|add_class:"form-control" }}
            </div>

            <div class="mb-2">
                <label class="form-label">Código</label>
                {{ formset.empty_form.codigo|add_class:"form-control" }}
            </div>

            <div class="mb-2">
                <label class="form-label">Imagen</label>
                {{ formset.empty_form.imagen|add_class:"form-control" }}
            </div>

            {% if formset.empty_form.DELETE %}
                <div class="form-check mt-2">
                    {{ formset.empty_form.DELETE }}
                    <label class="form-check-label">Eliminar este paso</label>
                </div>
            {% endif %}
        </div>
    </div>
</template>

<!-- Script para clonar pasos -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    const formsetContainer = document.getElementById("formset-container");
    const addFormBtn = document.getElementById("add-form");
    const emptyFormTemplate = document.getElementById("empty-form-template").innerHTML;
    const totalFormsInput = document.querySelector("input[name$='-TOTAL_FORMS']");

    addFormBtn.addEventListener("click", () => {
        let formCount = parseInt(totalFormsInput.value, 10);
        let newFormHtml = emptyFormTemplate.replace(/__prefix__/g, formCount);
        formsetContainer.insertAdjacentHTML("beforeend", newFormHtml);
        totalFormsInput.value = formCount + 1;
    });
});
</script>
{% endblock %}
